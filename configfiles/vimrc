" Use Vim settings, rather then Vi settings (much better!).
set nocompatible

set rtp+=~/.vim/bundle/neobundle.vim

call neobundle#begin(expand('~/.vim/bundle/'))

NeoBundleFetch 'Shougo/neobundle.vim'

NeoBundle 'sjl/clam.vim'
NeoBundle 'sjl/gundo.vim'

NeoBundle 'godlygeek/tabular'
NeoBundle 'davidhalter/jedi-vim'
NeoBundle 'scrooloose/nerdcommenter'
NeoBundle 'scrooloose/syntastic'
NeoBundle 'ctrlpvim/ctrlp.vim'
NeoBundle 'bling/vim-airline'
NeoBundle 'tpope/vim-fugitive'
NeoBundle 'tpope/vim-surround'
NeoBundle 'tpope/vim-unimpaired'
NeoBundle 'tpope/vim-repeat'
NeoBundle 'christoomey/vim-tmux-navigator'
NeoBundle 'jpalardy/vim-slime'
NeoBundle 'Wolfy87/vim-expand'

NeoBundle 'tpope/vim-fireplace'
NeoBundle 'guns/vim-clojure-static'
NeoBundle 'vim-scripts/paredit.vim'

NeoBundle 'mattn/emmet-vim'
NeoBundle 'altercation/vim-colors-solarized'
NeoBundle 'nanotech/jellybeans.vim'

NeoBundle 'chriskempson/vim-tomorrow-theme'
NeoBundle 'marijnh/tern_for_vim'
NeoBundle 'fatih/vim-go'

NeoBundle 'sirVer/ultisnips'
NeoBundle 'honza/vim-snippets'

NeoBundle 'klen/python-mode'
NeoBundle 'pangloss/vim-javascript'
NeoBundle 'mxw/vim-jsx'

call neobundle#end()

filetype plugin indent on     " required!

NeoBundleCheck

" Set augroup
augroup MyAutoCmd
  autocmd!
augroup END

" allow backspacing over everything in insert mode
set backspace=indent,eol,start
set listchars=eol:$,tab:>-,trail:~,extends:>,precedes:<

if has("vms")
  set nobackup		" do not keep a backup file, use versions instead
else
  set backup		" keep a backup file
endif

set nohlsearch
set history=1000		" keep 50 lines of command line history
set ruler		" show the cursor position all the time
set showcmd		" display incomplete commands
set incsearch		" do incremental searching
set shiftwidth=2
set tabstop=2
set number
set expandtab
set hidden
set laststatus=2
set cursorline
set scrolloff=3
set ignorecase
set smartcase
set smartindent
set smarttab
"set winwidth=84
set showcmd
set showmatch
set switchbuf=useopen
set wildmenu
set wildmode=longest,full
set clipboard=unnamed
set splitbelow
set splitright
"Autocomplete settings
set completeopt=menuone,longest
"enter key selects menu item
inoremap <expr> <CR> pumvisible() ? "\<C-y>" : "\<CR>"
"select an item by default
inoremap <expr> <C-n> pumvisible() ? '<C-n>' :
  \ '<C-n><C-r>=pumvisible() ? "\<lt>Down>" : ""<CR>'

set backupdir=~/.vim/backup/
set directory=~/.vim/swap/

set nojoinspaces
set autoread

set t_Co=256

let mapleader=","
nnoremap <silent> <Leader>, , " use double comma for find backwards

" Useful shortcuts for working with splits
nnoremap <silent> <Leader>h :sp<cr>
nnoremap <silent> <Leader>v :vsp<cr>
map <S-up> 2<C-w>+
map <S-down> 2<C-w>-
map <S-left> 4<C-w><
map <S-right> 4<C-w>>

nnoremap <silent> <Leader>+ :exe "resize " . (winheight(0) * 3/2)<CR>
nnoremap <silent> <Leader>- :exe "resize " . (winheight(0) * 2/3)<CR>
nnoremap <silent> <Leader>> :exe "vertical resize " . (winwidth(0) * 3/2)<CR>
nnoremap <silent> <Leader>< :exe "vertical resize " . (winwidth(0) * 2/3)<CR>

" Don't use Ex mode, use Q for formatting
map Q gq
" Make Y follow the same pattern as C and D
map Y y$

" CTRL-U in insert mode deletes a lot.  Use CTRL-G u to first break undo,
" so that you can undo CTRL-U after inserting a line break.
inoremap <C-U> <C-G>u<C-U>

" In many terminal emulators the mouse works just fine, thus enable it.
if has('mouse')
  set mouse=a
endif

"turn off docstring window for jedi
autocmd filetype python setlocal completeopt-=preview
"turn off docstring window for ternjs
autocmd filetype javascript setlocal completeopt-=preview

"put these in an autocmd group, so that we can delete them easily.
augroup vimrcex
  autocmd!

  " for all text files set 'textwidth' to 78 characters.
  autocmd FileType text setlocal textwidth=78

  " When editing a file, always jump to the last known cursor position.
  " Don't do it when the position is invalid or when inside an event handler
  " (happens when dropping a file on gvim).
  " Also don't do it when the mark is in the first line, that is the default
  " position when opening a file.
  autocmd BufReadPost *
        \ if line("'\"") > 1 && line("'\"") <= line("$") |
        \   exe "normal! g`\"" |
        \ endif

augroup END


" Convenient command to see the difference between the current buffer and the
" file it was loaded from, thus the changes you made.
" Only define it when not defined already.
if !exists(":DiffOrig")
  command DiffOrig vert new | set bt=nofile | r # | 0d_ | diffthis
        \ | wincmd p | diffthis
endif

nnoremap <leader>re :edit $MYVIMRC<CR>
nnoremap <leader>rs :source $MYVIMRC<CR>
nnoremap <leader>rn :set relativenumber!<CR>
nnoremap <leader>rw <C-w>x
inoremap <C-j> <Esc>

syntax enable

if has('gui_running')
  set guifont=Inconsolata\ for\ Powerline:h15
  set timeout
  set timeoutlen=500
else
  set ttimeoutlen=50
endif

set background=dark
if $vim_color == ""
  colorscheme solarized
else
  colorscheme $vim_color
endif

"turn off auto syntax checking for html because it doesn't like Angular
let syntastic_mode_map = { 'mode': 'passive', 'passive_filetypes': ['html'] }

imap <C-Y>s <Plug>snipMateNextOrTrigger
smap <C-Y>s <Plug>snipMateNextOrTrigger
let user_emmet_expandabbr_key = '<C-Y>y'

let g:ctrlp_open_new_file = 'r'
nmap <leader>m :CtrlPMRU<CR>
nmap <leader>gb :CtrlPBuffer<CR>
nmap <leader>ga :CtrlP app<CR>
nmap <leader>gj :CtrlP app/__tests__<CR>

nmap <leader>e :Explore<CR>
nnoremap <leader>u :GundoToggle<CR>
nnoremap <silent> <leader>. :set hlsearch!<cr>
nnoremap K i<cr><esc>
"remove trailing whitespace
map <leader>w :%s/\s\+$//<CR>

let g:ctrlp_max_height = 30

"turn off most of pymode by default
let g:pymode_rope = 0
let g:pymode_syntax = 1
let g:pymode_folding = 0
let g:pymode_rope_autocomplete_map = ""
let g:pymode_rope_vim_completion = 0
let g:pymode_lint=0
let g:pymode_options = 0

let g:jedi#show_call_signatures = 0
let g:jedi#goto_assignments_command = ''
let g:jedi#usages_command = '<leader><leader>n'
let g:jedi#popup_on_dot = 0
let g:jedi#show_call_signatures = 0

"Change default HTML indentation to include more tags
let g:html_indent_inctags = "html,body,head,tbody,p"

let g:UltiSnipsExpandTrigger="<tab>"
let g:UltiSnipsJumpForwardTrigger="<tab>"
let g:UltiSnipsJumpBackwardTrigger="<s-tab>"
let g:UltiSnipsEditSplit="horizontal"
nnoremap <leader>sn :UltiSnipsEdit<CR>

command! Snips :call UltiSnips#ListSnippets()

let g:slime_target = "tmux"

function! TmuxSendKeys(command, window)
  call system("tmux send-keys -t" . a:window . " '" . a:command . "' C-m")
endfunction

augroup GoAwayPreviewWindow
  autocmd! InsertLeave * wincmd z
augroup END

"enable the vim-vinegar features that I like
let g:netrw_banner = 0
nnoremap - :Explore<CR>
let g:netrw_list_hide='^\.\/'
autocmd FileType netrw nnoremap <buffer>gg :Rex<CR>

"change current directory to that of the current file
nmap <leader>cd :cd %:p:h<CR>

function! SwitchToTest()
  let b:root = expand('%:r:r')
  let b:ext = expand('%:e:e')
  if b:root =~ '-test'
    execute 'edit ' . substitute(expand('%'), '-test', '', '')
  else
    execute 'edit ' . b:root . '-test\.' . b:ext
  endif
endfunction

command! A :call SwitchToTest()

function! RenameFile()
  let old_name = expand('%')
  let new_name = input('New file name: ', expand('%'), 'file')
  if new_name != '' && new_name != old_name
    exec ':saveas ' . new_name
    exec ':silent !rm ' . old_name
    redraw!
  endif
endfunction

map <leader>rf :call RenameFile()<cr>

function! AckIntoArgsList()
  let name = input('Search for: ')
  let search_dir = input('Search in directory: ', 'app')
  exec ':args `ack ' . name . ' ' . search_dir . ' -l`'
endfunction

map <leader>a :call AckIntoArgsList()<cr>

function! Ack(args)
 let grepprg_bak=&grepprg
 set grepprg=ack\ -H\ --nocolor\ --nogroup
 execute ":silent grep " . a:args
 execute ":redraw!"
 let &grepprg=grepprg_bak
endfunction

command! -nargs=* -complete=file Ack call Ack(<q-args>)

" settings for vim-jsx
let g:jsx_pragma_required = 0
let g:jsx_ext_required = 1

if !exists('g:airline_symbols')
  let g:airline_symbols = {}
endif

" unicode symbols
let g:airline_left_sep = '»'
let g:airline_left_sep = '▶'
let g:airline_right_sep = '«'
let g:airline_right_sep = '◀'
let g:airline_symbols.linenr = '␊'
let g:airline_symbols.linenr = '␤'
let g:airline_symbols.linenr = '¶'
let g:airline_symbols.branch = '⎇'
let g:airline_symbols.paste = 'ρ'
let g:airline_symbols.paste = 'Þ'
let g:airline_symbols.paste = '∥'
let g:airline_symbols.whitespace = 'Ξ'

" powerline symbols
let g:airline_left_sep = ''
let g:airline_left_alt_sep = ''
let g:airline_right_sep = ''
let g:airline_right_alt_sep = ''
let g:airline_symbols.branch = ''
let g:airline_symbols.readonly = ''
let g:airline_symbols.linenr = ''

"set path for gf when working with require in Node
function! Nodegf()
python << EOF
import os
import sys
import vim

vim.command(r"set suffixesadd+=.js")

#
# walk up and check every folder for node_modules folder, 
# and if found add it to the path
#
current_folder = os.path.dirname(vim.eval("expand('%:p')"))
while current_folder is not "/":
	# print "Will check " + current_folder
	current = os.path.join(current_folder, 'node_modules')
	if os.path.exists(current): 
		# print "Will add " + current
		vim.command(r"set path+=%s" % (current.replace(" ", r"\ ")))
	current_folder = os.path.abspath(os.path.join(current_folder, '..'))
	
EOF
endfunction

augroup Node
  autocmd!
  autocmd filetype javascript :call Nodegf()
augroup END 

